import time
import board
import busio
from digitalio import DigitalInOut, Direction
import adafruit_fingerprint

# Initialize UART connection
uart = busio.UART(board.GP0, board.GP1, baudrate=57600)
finger = adafruit_fingerprint.Adafruit_Fingerprint(uart)

def enroll_finger(location):
    print(f"Enrolling fingerprint #{location}...")

    for fingerimg in range(1, 3):
        print(f"Place finger on sensor for template #{fingerimg}...")

        while finger.get_image() != adafruit_fingerprint.OK:
            pass

        print("Image taken. Templating...")

        if finger.image_2_tz(fingerimg) != adafruit_fingerprint.OK:
            print("Templating failed. Please try again.")
            return False

        time.sleep(1)

    print("Creating and storing model...")

    if finger.create_model() != adafruit_fingerprint.OK or \
            finger.store_model(location) != adafruit_fingerprint.OK:
        print("Enrollment failed.")
        return False

    print("Enrollment successful!")
    return True

def verify_finger():
    print("Verifying fingerprint...")

    while finger.get_image() != adafruit_fingerprint.OK:
        pass

    print("Image taken. Searching...")

    if finger.finger_fast_search() == adafruit_fingerprint.OK:
        print(f"Fingerprint identified! Person ID: {finger.finger_id}")
    else:
        print("No match found.")

# Main loop
while True:
    print("----------------")
    print("1) Enroll Fingerprint")
    print("2) Verify Fingerprint")
    print("3) Exit")
    print("----------------")
    
    choice = input("Enter choice (1-3): ")

    if choice == "1":
        enroll_finger(int(input("Enter fingerprint ID (1-127): ")))
    elif choice == "2":
        verify_finger()
    elif choice == "3":
        print("Exiting program.")
        break
    else:
        print("Invalid choice. Please enter a valid option.")
